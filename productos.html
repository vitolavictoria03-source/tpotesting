<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Tienda de Barritas de Cereal</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="Estilo.css">
</head>

<body>
  <header class="hero">
    <a href="index.html"><img src="logobanner.png" alt="Logo EneBar" class="logo"></a>
  </header>

  <main class="catalog">
    <div class="toolbar">
      <div class="search">
        <input id="q" class="search-input" type="search" placeholder="Buscar barritas por nombre o sabor…">
      </div>
      <div class="sort">
        <select id="sort">
          <option value="price-asc">Precio: menor a mayor</option>
          <option value="price-desc">Precio: mayor a menor</option>
          <option value="protein-desc">Proteína: más a menos</option>
          <option value="protein-asc">Proteína: menos a más</option>
        </select>
      </div>
    </div>

    <div class="catalog-layout">
      <aside class="filters">
        <h3>Filtros</h3>
        <div class="field">
          <label for="protein">Cantidad de proteína: <small>(por barra)</small></label>
          <select id="protein">
            <option value="">Todas</option>
            <option value="20+">20g o más</option>
            <option value="10-19">10–19g</option>
            <option value="<10">Menos de 10g</option>
          </select>
        </div>
        <div class="field">
          <label><strong>Precio</strong></label>
          <div class="range">
            <input id="min" type="number" placeholder="Mín.">
            <input id="max" type="number" placeholder="Máx.">
          </div>
        </div>
        <div class="field check"><input id="vegan" type="checkbox"> <label for="vegan">Vegano</label></div>
        <div class="field check"><input id="gf" type="checkbox"> <label for="gf">Apto celíacos (Sin TACC)</label></div>
        <button id="clear" class="btn btn-clear">Limpiar filtros</button>
      </aside>

      <section>
        <div id="count" class="products-count"></div>
        <div id="catalog" class="products"></div>
        <div id="empty" class="empty" style="display:none">No se encontraron resultados con los filtros aplicados.</div>
      </section>
    </div>

    <!-- Popup carrito -->
    <div id="cart-overlay" class="cart-overlay" hidden>
      <div class="cart-popup" role="dialog" aria-modal="true" aria-labelledby="cp-title">
        <button class="cp-close" id="cp-close" aria-label="Cerrar">×</button>
        <div class="cp-row">
          <img id="cp-img" class="cp-img" alt="">
          <div class="cp-info">
            <p id="cp-title" class="cp-title">Producto</p>
            <p class="cp-line"><span id="cp-qty">1</span> × <span id="cp-price">$0</span></p>
            <p class="cp-added">¡Agregado al carrito!</p>
          </div>
        </div>
        <hr class="cp-sep">
        <div class="cp-total"><span>Total:</span><strong id="cp-total">$0</strong></div>
        <div class="cp-actions">
          <button id="cp-continue" class="cp-btn light">Seguir comprando</button>
          <a id="cp-view" class="cp-btn" href="carrito.html">Ver carrito</a>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="footer-wrap">
      <p class="footer-eyebrow">Conoce más sobre</p>
      <img src="logofooter.png" alt="Logo EneBar" class="footer-logo">
      <ul class="footer-links">
        <li><a href="#">¿Quiénes somos?</a></li>
        <li><a href="#">¿Dónde encontrarnos?</a></li>
        <li><a href="productos.html">Nuestras Barritas</a></li>
        <li><a href="#">Contáctanos</a></li>
        <li><a href="#">Nuestras Redes</a></li>
      </ul>
      <div class="footer-icons">
        <a href="https://instagram.com" aria-label="Instagram" target="_blank" rel="noopener"><i class="bi bi-instagram" style="font-size:1.3rem;"></i></a>
        <a href="https://twitter.com" aria-label="Twitter" target="_blank" rel="noopener"><i class="bi bi-twitter" style="font-size:1.3rem;"></i></a>
        <a href="mailto:contacto@enebar.com" aria-label="Email"><i class="bi bi-envelope" style="font-size:1.3rem;"></i></a>
      </div>
    </div>
  </footer>
  <script>
document.addEventListener('DOMContentLoaded', () => {
  // ================== DATA ==================
    const DATA = [
      { id:1, name:'Power Almond Choco', flavor:'Chocolate, avena y almendras', ingredients:'Avena integral, almendras, chips de chocolate amargo, miel natural.', protein:18, price:1999, unitWeight:45, units:3, kcal:190, pricePerUnit:666, rating:4.6, stock:12, vegan:false, glutenFree:true, img:'img/almendraavenachips.png' },
    { id:2, name:'White Crunch', flavor:'Chocolate blanco y almendra', ingredients:'Avena, almendras tostadas, chocolate blanco, semillas de chía y maní.', protein:15, price:2199, unitWeight:40, units:3, kcal:185, pricePerUnit:733, rating:4.4, stock:10, vegan:false, glutenFree:true, img:'img/almendrachoblancoavena.png' },
    { id:3, name:'Tropical Energy', flavor:'Banana y pasas', ingredients:'Avena, pasas rubias, banana deshidratada, almendras y miel.', protein:12, price:1699, unitWeight:38, units:3, kcal:170, pricePerUnit:566, rating:4.3, stock:16, vegan:false, glutenFree:true, img:'img/almendrapasabanan.png' },
    { id:4, name:'Vital Mix', flavor:'Semillas y pasas', ingredients:'Semillas de girasol, almendras, pasas negras, avena y miel orgánica.', protein:14, price:1799, unitWeight:40, units:3, kcal:175, pricePerUnit:599, rating:4.5, stock:8, vegan:true, glutenFree:true, img:'img/almendrapasassemilla.png' },
    { id:5, name:'Green Pistachio Boost', flavor:'Pistacho y pasas', ingredients:'Pistachos, pasas negras, avena inflada y miel natural.', protein:20, price:2499, unitWeight:42, units:3, kcal:210, pricePerUnit:833, rating:4.8, stock:14, vegan:false, glutenFree:false, img:'img/apasaspistacho.png' },
    { id:6, name:'Nut Fusion', flavor:'Avellanas, cajú y pasas', ingredients:'Avellanas, castañas de cajú, pasas rubias, avena y jarabe de arroz.', protein:11, price:1899, unitWeight:40, units:3, kcal:180, pricePerUnit:633, rating:4.1, stock:20, vegan:false, glutenFree:false, img:'img/avellanacajualmendrapasa.png' },
    { id:7, name:'Dark Choco Raisin', flavor:'Chocolate negro y pasas', ingredients:'Avena, chips de cacao 70%, pasas negras, miel y aceite de coco.', protein:13, price:1899, unitWeight:40, units:3, kcal:185, pricePerUnit:633, rating:4.2, stock:15, vegan:false, glutenFree:true, img:'img/avenachocolatepasas.png' },
    { id:8, name:'Apple Crunch', flavor:'Avena y manzana', ingredients:'Avena, trozos de manzana deshidratada, miel, canela y chía.', protein:10, price:1599, unitWeight:38, units:3, kcal:165, pricePerUnit:533, rating:4.1, stock:18, vegan:true, glutenFree:true, img:'img/avenamanzana.png' },
    { id:9, name:'Coconut Trail', flavor:'Pasas y coco rallado', ingredients:'Avena inflada, pasas negras, coco rallado, almendras y miel.', protein:11, price:1699, unitWeight:38, units:3, kcal:170, pricePerUnit:566, rating:4.3, stock:17, vegan:true, glutenFree:true, img:'img/avenapasas.png' }
    ];

    // ================== HELPERS / REFS ==================
    const $  = s => document.querySelector(s);
    const money = n => n.toLocaleString('es-AR',{style:'currency',currency:'ARS'});

    // Filtros / UI
    const q=$('#q'), sort=$('#sort'), protein=$('#protein'), min=$('#min'), max=$('#max');
    const vegan=$('#vegan'), gf=$('#gf'), clear=$('#clear'), chips=$('#active-chips');
    const catalog=$('#catalog'), count=$('#count'), empty=$('#empty');

    // Popup carrito
    const overlay = $('#cart-overlay');
    const cpImg   = $('#cp-img');
    const cpTitle = $('#cp-title');
    const cpQty   = $('#cp-qty');
    const cpPrice = $('#cp-price');
    const cpTotal = $('#cp-total');
    const cpClose = $('#cp-close');
    const cpContinue = $('#cp-continue');

    // Estado de filtros
    let state = {query:'', sort:'price-asc', protein:'', min:null, max:null, vegan:false, gf:false};

    // ================== CART (localStorage) ==================
    const CART_KEY = 'enebar_cart';
    const getCart = () => { try{ return JSON.parse(localStorage.getItem(CART_KEY))||[] } catch { return []; } };
    const setCart = c => localStorage.setItem(CART_KEY, JSON.stringify(c));

    function addToCart(prod, qty=1){
      const cart = getCart();
      const i = cart.findIndex(p => p.id === prod.id);
      const inCartQty = i>-1 ? (cart[i].qty||1) : 0;

      // Control de stock
      if (typeof prod.stock === 'number' && inCartQty + qty > prod.stock) {
        alert('No hay más stock disponible de este producto.');
        return false;
      }

      if(i>-1){ cart[i].qty = inCartQty + qty; }
      else { cart.push({ id: prod.id, name: prod.name, price: prod.price, img: prod.img, flavor: prod.flavor, qty }); }
      setCart(cart);
      return true;
    }
    const cartQty  = () => getCart().reduce((a,i)=>a+(i.qty||1),0);
    const cartTotal= () => getCart().reduce((a,i)=>a+i.price*(i.qty||1),0);

    // ================== LISTENERS ==================
    if(q) q.addEventListener('input', () => { state.query = q.value.trim().toLowerCase(); render(); });
    if(sort) sort.addEventListener('change', () => { state.sort = sort.value; render(); });
    if(protein) protein.addEventListener('change', () => { state.protein = protein.value; render(); });

    const syncPrice = () => {
      const minVal = Number(min?.value);
      const maxVal = Number(max?.value);
      state.min = Number.isFinite(minVal) && min && min.value!=='' ? minVal : null;
      state.max = Number.isFinite(maxVal) && max && max.value!=='' ? maxVal : null;
      render();
    };
    if(min){ min.addEventListener('input', syncPrice); }
    if(max){ max.addEventListener('input', syncPrice); }
    if(vegan) vegan.addEventListener('change', () => { state.vegan = vegan.checked; render(); });
    if(gf) gf.addEventListener('change', () => { state.gf = gf.checked; render(); });

    if(clear) clear.addEventListener('click', () => {
      state = {query:'', sort:'price-asc', protein:'', min:null, max:null, vegan:false, gf:false};
      if(q) q.value='';
      if(sort) sort.value='price-asc';
      if(protein) protein.value='';
      if(min) min.value='';
      if(max) max.value='';
      if(vegan) vegan.checked=false;
      if(gf) gf.checked=false;
      render();
    });

    // ================== POPUP ==================
    function showCartPopup(item){
      if(!overlay) return;
      cpImg.src = item.img || 'https://placehold.co/100x100?text=Barrita';
      cpImg.alt = 'Barrita ' + item.name;
      cpTitle.textContent = item.name;

      // cantidad de ese ítem en el carrito
      const itemInCart = getCart().find(p=>p.id===item.id);
      cpQty.textContent   = itemInCart?.qty || 1;
      cpPrice.textContent = money(item.price);
      cpTotal.textContent = money(cartTotal()); // total del carrito

      overlay.hidden = false;
      document.body.classList.add('modal-open');

      const close = () => {
        overlay.hidden = true;
        document.body.classList.remove('modal-open');
        document.removeEventListener('keydown', esc);
      };
      const esc = e => { if(e.key === 'Escape') close(); };

      if(cpClose) cpClose.onclick = close;
      if(cpContinue) cpContinue.onclick = close;
      document.addEventListener('keydown', esc);
      overlay.addEventListener('click', (e)=>{ if(e.target === overlay) close(); }, { once:false });
    }

    // ================== FILTROS ==================
    function applyFilters(data){
      return data
        .filter(x => {
          if (state.query && !(`${x.name} ${x.flavor}`.toLowerCase().includes(state.query))) return false;
          if (state.protein==='20+'   && !(x.protein>=20)) return false;
          if (state.protein==='10-19' && !(x.protein>=10 && x.protein<=19)) return false;
          if (state.protein==='<10'   && !(x.protein<10)) return false;
          if (state.vegan && !x.vegan) return false;
          if (state.gf && !x.glutenFree) return false;
          if (state.min!=null && x.price < state.min) return false;
          if (state.max!=null && x.price > state.max) return false;
          return true;
        })
        .sort((a,b) => {
          switch(state.sort){
            case 'price-asc':    return a.price - b.price;
            case 'price-desc':   return b.price - a.price;
            case 'protein-desc': return b.protein - a.protein;
            case 'protein-asc':  return a.protein - b.protein;
            default: return 0;
          }
        });
    }

    const hasActiveFilters = () =>
      (state.query && state.query.length) ||
      state.protein ||
      state.vegan || state.gf ||
      state.min != null || state.max != null;

    function renderChips(){
      if(!chips) return;
      const arr = [];
      if(state.query)   arr.push(`Búsqueda: "${state.query}"`);
      if(state.protein) arr.push(`Proteína: ${state.protein}`);
      if(state.min!=null) arr.push(`Min: ${money(state.min)}`);
      if(state.max!=null) arr.push(`Max: ${money(state.max)}`);
      if(state.vegan)   arr.push('Vegano');
      if(state.gf)      arr.push('Sin TACC');
      chips.innerHTML = arr.length ? arr.map(t=>`<span class="chip">${t}</span>`).join('') : '<span class="chip">Sin filtros</span>';
    }

    // ================== RENDER ==================
    function starsFrom(r){
      const full = Math.round(r*2)/2, on = Math.floor(full), half = full - on >= 0.5;
      return '★★★★★'.slice(0,on) + (half?'★':'') + '<span class="off">' + '★★★★★'.slice(0,5-on-(half?1:0)) + '</span>';
    }

    function updateCount(listLen){
      if(count) count.textContent = `${listLen} producto${listLen!==1?'s':''} · ${cartQty()} en el carrito`;
    }

    function render(){
      let items = applyFilters(DATA);
      if (!hasActiveFilters() && items.length === 0) items = DATA.slice();

      renderChips();

      catalog.innerHTML = items.map(x=>`
        <article class="product-card" data-id="${x.id}">
          <div class="media">
            <img src="${x.img || 'https://placehold.co/800x800?text=Barrita'}" alt="Barrita ${x.name}">
          </div>
          <div class="body">
            <div>
              ${x.glutenFree ? '<span class="badge">Sin TACC</span>' : ''}
              ${x.vegan ? '<span class="badge">Vegano</span>' : ''}
            </div>
            <h3 class="title">${x.name}</h3>
            <ul class="specs">
              <li><strong>Sabor:</strong> ${x.flavor}</li>
              <li><strong>Proteína:</strong> ${x.protein} g por barra</li>
              <li><strong>Pack:</strong> ${x.units} unidades · ${x.unitWeight} g c/u</li>
              <li><strong>Calorías:</strong> ${x.kcal} kcal c/u</li>
            </ul>
            <div class="rating">
              <span class="stars">${starsFrom(x.rating)}</span>
              <span>${x.rating.toFixed(1)}</span>
            </div>
          </div>
          <div class="footer">
            <div class="price-row">
              <div class="price">${money(x.price)}</div>
              <div class="unit">(${money(x.pricePerUnit)}/u)</div>
            </div>
            ${
              x.stock>0
                ? `<button class="btn-add"><i class="bi bi-cart-plus"></i> Agregar</button>`
                : `<button class="btn-add" disabled style="opacity:.6;cursor:not-allowed"><i class="bi bi-x-circle"></i> Sin stock</button>`
            }
          </div>
        </article>
      `).join('');

      if(empty) empty.style.display = items.length ? 'none' : 'block';
      updateCount(items.length);
    }

    // ===== Delegación de eventos para “Agregar” (robusto a re-render) =====
    catalog.addEventListener('click', (e) => {
      const btn = e.target.closest('.btn-add');
      if(!btn) return;

      const card = btn.closest('.product-card');
      const id = Number(card?.dataset?.id);
      const prod = DATA.find(p => p.id === id);
      if(!prod) return;

      if (prod.stock === 0) return; // defensa extra

      const ok = addToCart(prod, 1);
      if(ok){
        updateCount(applyFilters(DATA).length);
        showCartPopup(prod);
      }
    });

    // Cerrar popup (seguridad por si el HTML está sin listeners)
    const hardClose = () => {
      overlay.hidden = true;
      document.body.classList.remove('modal-open');
    };
    if(cpClose) cpClose.addEventListener('click', hardClose);
    if(cpContinue) cpContinue.addEventListener('click', hardClose);
    overlay?.addEventListener('click', (e)=>{ if(e.target === overlay) hardClose(); });

    // Render inicial
    render();
  });
</script>

</body>
</html>
