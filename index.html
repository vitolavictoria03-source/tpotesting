<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Usuario</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="Estilo.css">
</head>
<body class="center">
  <main class="card">
    <!-- Franja superior con logo -->
    <header class="hero">
      <img src="logobanner.png" alt="Logo EneBar" class="logo">
    </header>

    <h1>Registro</h1>
    <p>Completa los datos para registrarte</p>

    <form id="form-registro" novalidate>
      <label for="nombre">Nombre:</label>
      <input id="nombre" required placeholder="Ej: Ana P√©rez" class="input">

      <!-- PROVINCIA -->
      <label for="provincia">Provincia:</label>
      <select id="provincia" required class="input">
        <option value="">Seleccion√° tu provincia</option>
        <option value="Buenos Aires">Buenos Aires</option>
        <option value="CABA">Ciudad Aut√≥noma de Buenos Aires</option>
        <option value="Catamarca">Catamarca</option>
        <option value="Chaco">Chaco</option>
        <option value="Chubut">Chubut</option>
        <option value="C√≥rdoba">C√≥rdoba</option>
        <option value="Corrientes">Corrientes</option>
        <option value="Entre R√≠os">Entre R√≠os</option>
        <option value="Formosa">Formosa</option>
        <option value="Jujuy">Jujuy</option>
        <option value="La Pampa">La Pampa</option>
        <option value="La Rioja">La Rioja</option>
        <option value="Mendoza">Mendoza</option>
        <option value="Misiones">Misiones</option>
        <option value="Neuqu√©n">Neuqu√©n</option>
        <option value="R√≠o Negro">R√≠o Negro</option>
        <option value="Salta">Salta</option>
        <option value="San Juan">San Juan</option>
        <option value="San Luis">San Luis</option>
        <option value="Santa Cruz">Santa Cruz</option>
        <option value="Santa Fe">Santa Fe</option>
        <option value="Santiago del Estero">Santiago del Estero</option>
        <option value="Tierra del Fuego">Tierra del Fuego</option>
        <option value="Tucum√°n">Tucum√°n</option>
      </select>

      <!-- FECHA DE NACIMIENTO -->
      <label for="fecha">Fecha de nacimiento:</label>
      <input id="fecha" type="date" required class="input">

      <!-- EMAIL -->
      <label for="email">Email:</label>
      <input id="email" type="email" required placeholder="ana@email.com" class="input">

      <!-- CONTRASE√ëA -->
      <div class="field">
        <label for="password">Contrase√±a</label>
        <input id="password" type="password" placeholder="Ingres√° tu contrase√±a" />
        <button type="button" id="togglePwd" aria-label="Mostrar/Ocultar contrase√±a">
          <i class="bi bi-eye"></i>
        </button>
      </div>

      <div class="actions">
        <button class="btn primary" type="submit">Registrarme</button>
        <a href="Login.html">¬øYa tienes usuario?</a>
      </div>
      <div id="msg" class="msg" style="display:none"></div>
    </form>

    <!-- POPUP: √âxito -->
    <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="popupTitle">
      <div class="popup">
        <h2 id="popupTitle">‚úÖ Registro exitoso</h2>
        <p>Tu cuenta se cre√≥ correctamente</p>
        <button class="btn" id="closeBtn">Siguiente</button>
      </div>
    </div>

    <!-- POPUP: Campos vac√≠os -->
    <div id="pop-empty" class="overlay" role="dialog" aria-modal="true" aria-labelledby="emptyTitle">
      <div class="popup">
        <h2 id="emptyTitle">‚ö†Ô∏è Campos vac√≠os</h2>
        <p>Complet√° <strong>nombre, email y contrase√±a</strong> para continuar.</p>
        <button class="btn" data-close="pop-empty">Entendido</button>
      </div>
    </div>

    <!-- POPUP: Faltan datos / inv√°lidos -->
    <div id="pop-missing" class="overlay" role="dialog" aria-modal="true" aria-labelledby="missingTitle">
      <div class="popup">
        <h2 id="missingTitle">‚ö†Ô∏è Faltan datos v√°lidos</h2>
        <p>Revis√° lo siguiente:</p>
        <ul id="missing-list"></ul>
        <button class="btn" data-close="pop-missing">Corregir</button>
      </div>
    </div>

    <!-- POPUP: Usuario ya conectado -->
    <div id="pop-logged" class="overlay" role="dialog" aria-modal="true" aria-labelledby="loggedTitle">
      <div class="popup">
        <h2 id="loggedTitle">‚ö†Ô∏è Sesi√≥n ya iniciada</h2>
        <p>El email ingresado ya tiene una sesi√≥n activa. Cerr√° la sesi√≥n existente antes de registrarte nuevamente.</p>
        <button class="btn" data-close="pop-logged">Entendido</button>
      </div>
    </div>

    <!-- POPUP: Email ya registrado -->
    <div id="pop-duplicate" class="overlay" role="dialog" aria-modal="true" aria-labelledby="dupTitle">
      <div class="popup">
        <h2 id="dupTitle">‚ö†Ô∏è Email ya registrado</h2>
        <p>El correo ingresado ya existe. Inici√° sesi√≥n o us√° otro email.</p>
        <button class="btn" data-close="pop-duplicate">Entendido</button>
      </div>
    </div>

    <footer class="site-footer">
      <div class="footer-wrap">
        <p class="footer-eyebrow">Conoce m√°s sobre</p>
        <img src="logofooter.png" alt="Logo EneBar" class="footer-logo">
        <ul class="footer-links">
          <li><a href="#">¬øQuienes somos?</a></li>
          <li><a href="#">¬øD√≥nde encontrarnos?</a></li>
          <li><a href="productos.html">Nuestras Barritas</a></li>
          <li><a href="#">Contactanos</a></li>
          <li><a href="#">Nuestras Redes</a></li>
        </ul>
        <div class="footer-icons">
          <a href="https://instagram.com" aria-label="Instagram" target="_blank" rel="noopener">
            <i class="bi bi-instagram" style="font-size:1.3rem;"></i>
          </a>
          <a href="https://twitter.com" aria-label="Twitter" target="_blank" rel="noopener">
            <i class="bi bi-twitter" style="font-size:1.3rem;"></i>
          </a>
          <a href="mailto:contacto@enebar.com" aria-label="Email">
            <i class="bi bi-envelope" style="font-size:1.3rem;"></i>
          </a>
        </div>
      </div>
    </footer>
  </main>

  <script>
    // Usuarios existentes
    const USERS = [
      { email: 'vitolavictoria03@gmail.com', password: 'Vicky012' },
      { email: 'amorenadelfina15@gmail.com', password: 'Delfi123' },
      { email: 'luciano.gadea@gmail.com',    password: 'Lucho1234' }
    ];

    // ====== Utils DOM ======
    const $ = s => document.querySelector(s);
    const nombre = $('#nombre'), email = $('#email'), pass = $('#password'), msg = $('#msg');
    const form = $('#form-registro');

    // Validaciones
    const reEmail = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
    const rePwd   = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{5,}$/;

    // Mostrar/ocultar contrase√±a
    const pwd = document.getElementById('password');
    const togglePwd = document.getElementById('togglePwd');
    togglePwd?.addEventListener('click', () => {
        const isPwd = pwd.type === 'password';
        pwd.type = isPwd ? 'text' : 'password';
        togglePwd.innerHTML = isPwd
          ? '<i class="bi bi-eye" aria-hidden="true"></i>'       // üëÅÔ∏è ojo abierto al mostrar
          : '<i class="bi bi-eye-slash" aria-hidden="true"></i>'; // üëÅÔ∏è tachado al ocultar
    });

    // Popups
    function openPopup(id){ document.getElementById(id).style.display = 'flex'; }
    function closePopup(id){ document.getElementById(id).style.display = 'none'; }
    document.querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click',()=>closePopup(b.getAttribute('data-close'))));
    ['overlay','pop-empty','pop-missing','pop-logged','pop-duplicate'].forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener('click', e => { if(e.target === el) el.style.display = 'none'; });
    });

    // Estados de inputs
    function setState(input, ok){ input.classList.toggle('ok', ok); input.classList.toggle('err', !ok); return ok; }
    const vNombre = () => setState(nombre, nombre.value.trim().length >= 2);
    const vEmail  = () => setState(email,  reEmail.test(email.value.trim()));
    const vPwd    = () => setState(pass,   rePwd.test(pass.value.trim()));
    [nombre, email, pass].forEach(i => i.addEventListener('input', () => {
      if(i===nombre) vNombre(); if(i===email) vEmail(); if(i===pass) vPwd();
    }));

    // ====== Gesti√≥n de sesiones activas ======
    function getActiveSessions(){
      try { return JSON.parse(localStorage.getItem('activeSessions')) || []; }
      catch { return []; }
    }
    function isUserConnected(mail){
      const sessions = getActiveSessions();
      return sessions.includes(mail.toLowerCase());
    }

    // ====== Usuarios registrados (persistidos) ======
    function getRegisteredUsers(){
      try { return JSON.parse(localStorage.getItem('registeredUsers')) || []; }
      catch { return []; }
    }
    function setRegisteredUsers(list){
      localStorage.setItem('registeredUsers', JSON.stringify(list));
    }

    // Sembrar una vez los USERS base como ya registrados (opcional)
    if (!localStorage.getItem('seededBaseUsers')) {
      const base = getRegisteredUsers();
      const seed = USERS
        .map(u => ({ nombre: '', email: u.email.toLowerCase() }))
        .filter(u => !base.some(b => b.email === u.email));
      if (seed.length) setRegisteredUsers(base.concat(seed));
      localStorage.setItem('seededBaseUsers', '1');
    }

    // ====== Submit ======
    const overlay = $('#overlay');
    const closeBtn = $('#closeBtn');

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      msg.style.display = 'none';

      const n = nombre.value.trim();
      const m = email.value.trim().toLowerCase();
      const p = pass.value.trim();

      // 1) Vac√≠os
      if (!n && !m && !p) { openPopup('pop-empty'); return; }

      // 2) Inv√°lidos
      const faltantes = [];
      if (n.length < 2) faltantes.push('‚Ä¢ Nombre: m√≠nimo 2 caracteres.');
      if (!reEmail.test(m)) faltantes.push('‚Ä¢ Email con formato v√°lido (usuario@dominio).');
      if (!rePwd.test(p))  faltantes.push('‚Ä¢ Contrase√±a: 1 may√∫scula, 1 min√∫scula, 1 n√∫mero y m√≠nimo 5 caracteres.');
      if (faltantes.length > 0) {
        $('#missing-list').innerHTML = faltantes.map(x => `<li>${x}</li>`).join('');
        openPopup('pop-missing'); return;
      }

      // 3) Email ya registrado (en base hardcode o en localStorage)
      const existsInBase  = USERS.some(u => u.email.toLowerCase() === m);
      const existsInLocal = getRegisteredUsers().some(u => u.email === m);
      if (existsInBase || existsInLocal) { openPopup('pop-duplicate'); return; }

      // 4) Sesi√≥n activa
      if (isUserConnected(m)) { openPopup('pop-logged'); return; }

      // 5) Registrar y persistir
      const regs = getRegisteredUsers();
      regs.push({ nombre: n, email: m });
      setRegisteredUsers(regs);

      localStorage.setItem('usuario', JSON.stringify({ nombre: n, email: m }));

      // 6) √âxito
      overlay.style.display = 'flex';
    });

    // Cerrar popup de √©xito ‚Üí redirigir
    closeBtn.addEventListener('click', () => {
      overlay.style.display = 'none';
      window.location.href = 'productos.html';
    });
  </script>
</body>
</html>
